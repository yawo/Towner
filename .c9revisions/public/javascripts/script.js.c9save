{"ts":1346055934292,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"//TODO : Reset currentPages, etc on filter change.\r\nvar map,marker,geocoder;\r\nvar productIndex=0;\r\nvar allProducts = [];\r\nvar initPage = 0;\r\nvar currentPage = initPage;\r\nvar newProductvalidator;\r\nvar colorBoxOptions = {inline:true,href:\"#dialog-form\",opacity:0.8,top:135,left:300};\r\nvar serverUrl = 'http://googlemaps.mcguy.c9.io';\r\n//This is the compilation of partials/product.jade template\r\nvar productDetailsTemplate = '<div class=\"product-details ui-corner-all\"> <span id=\"product-details-_id\" class=\"ui-helper-hidden\"> </span><table><tr class=\"details-head\"><td><b id=\"product-details-title\"> </b><span id=\"product-details-actions\"><input name=\"details-mark\" id=\"details-mark\" placeholder=\"0\" size=\"1\" class=\"input details-mark ui-widget ui-corner-all\"/><span id=\"mark-action\" title=\"How much will you mark it on 20 points?\" onclick=\"productScore(2,0,0)\"></span><span id=\"like-action\" title=\"Did you like it  ?\" onclick=\"productScore(1,0,0)\"> </span><span id=\"unlike-action\" title=\"Something hurts about it ?\" onclick=\"productScore(-1,0,0)\"> </span><span id=\"signal-action\" title=\"Is this erronous or Bad ?\" onclick=\"productScore(-2,0,0)\"> </span><span id=\"close-action\" title=\"close\" onclick=\"productDetailsClear()\"> </span></span></td></tr><tr>     <td colspan=\"2\" class=\"details-description\"><div id=\"product-details-description\"></div></td></tr></table></div>';\r\nvar zoom=5;\r\nvar isAuthenticated=false;\r\nvar enums = {\r\n    scores:{mark:2,like:1,unlike:-1,erronous:-2}\r\n};\r\n\r\nfunction setAuthenticated(auth){\r\n    isAuthenticated=auth;    \r\n    console.log(\"auth?\",auth);\r\n}\r\nfunction initialize() {\r\n      var myOptions = {\r\n          center: new google.maps.LatLng(-34.397, 150.644),\r\n          //center: new google.maps.LatLng(-4.5, 15.5),      \r\n          zoom: zoom,\r\n          mapTypeId: google.maps.MapTypeId.ROADMAP\r\n        };\r\n      \r\n      map = new google.maps.Map(document.getElementById('map_canvas'),\r\n        myOptions);\r\n    \r\n       marker = new google.maps.Marker({\r\n        position: map.getCenter(),\r\n        map: map,\r\n        title: 'Click to zoom'\r\n      });\r\n      \r\n      geocoder = new google.maps.Geocoder();\r\n    \r\n      google.maps.event.addListener(marker, 'click', function() {\r\n        //map.setZoom(zoom);\r\n        //map.setCenter(marker.getPosition());\r\n      });\r\n      \r\n      google.maps.event.addListener(map, 'click', function(event) {\r\n        placeMarker(event.latLng);\r\n      });\r\n      \r\n       google.maps.event.addListener(map, 'dblclick', function(event) {\r\n          //var ptitle = prompt(\"Please give product title:\",\"Prod\"+productIndex++);\r\n          //var loc = [Math.round(event.latLng.lng()*1000)/1000,Math.round(event.latLng.lat()*1000)/1000];\r\n          //[event.latLng.lat()*1000,event.latLng.lng()]\r\n          createProductAt(event.latLng);         \r\n           //map.setZoom(zoom);\r\n      });\r\n      \r\n      google.maps.event.addListener(map, 'center_changed', function() {\r\n        /*// 3 seconds after the center of the map has changed, pan back to the\r\n        // marker.\r\n        window.setTimeout(function() {\r\n          map.panTo(marker.getPosition());\r\n        }, 3000);*/\r\n      });\r\n   // Try HTML5 geolocation\r\n    if(navigator.geolocation) {\r\n      navigator.geolocation.getCurrentPosition(function(position) {\r\n        var pos = new google.maps.LatLng(position.coords.latitude,\r\n                                         position.coords.longitude);\r\n        map.setCenter(pos);\r\n        placeMarker(pos);\r\n      }, function(err) {\r\n        console.log(\" GeoLocation Error\",err);\r\n        handleNoGeolocation(true);\r\n      });\r\n    } else {\r\n      // Browser doesn't support Geolocation\r\n      handleNoGeolocation(false);\r\n    }\r\n }\r\n\r\n  function handleNoGeolocation(errorFlag) {\r\n        if (errorFlag) {\r\n          var content = 'Geolocation service failed. Please browse map to your position';\r\n        } else {\r\n          var content = 'Error: Your browser doesn\\'t support geolocation.';\r\n        }\r\n    \r\n        var options = {\r\n          map: map,\r\n          position: new google.maps.LatLng(-34.397, 150.644),\r\n          content: content\r\n        };\r\n    \r\n        var infowindow = new google.maps.InfoWindow(options);\r\n        map.setCenter(options.position);\r\n        map.setZoom(zoom);\r\n\r\n  }\r\n\r\n\r\n\r\n function placeMarker(location) {\r\n  marker.setPosition(location);    \r\n  //map.setCenter(location);\r\n  geocoder.geocode({'latLng': location}, function(results, status) {\r\n      if (status == google.maps.GeocoderStatus.OK) {\r\n        if (results[1]) { \r\n          //map.setZoom(zoom)\r\n          //$(\".result\").html(\"Your click position is (Lat/Long) : <b>\"+location.lat()+\" / \"+location.lng()+\".</b> (\"+results[1].formatted_address+\")\");\r\n          $(\".result\").html(\"<small>Near  Â» <span>\"+results[1].formatted_address+\".</span> (lng:\"\r\n                  +Math.round(location.lng()*100)/100+\", lat:\"+Math.round(location.lat()*100)/100+\")<small>\");\r\n             \r\n             //fetchProducts([location.lng(),location.lat()]);\r\n             loadResults(-1);\r\n        }\r\n      } else {\r\n        alert(\"Geocoder failed due to: \" + status);\r\n      }\r\n    }); \r\n }\r\n \r\n /*function fetchProducts(loc){\r\n     var loc = loc || [marker.getPosition().lng(),marker.getPosition().lat()]\r\n         ,category = $('#category-filter').val(), keywords = $('#content-filter').val();\r\n     var url = '/storelocation',reg = new RegExp(\"[ ,;\\+]+\", \"g\");\r\n     var kw  = (keywords?keywords.split(reg):[]);     \r\n     $(\".product-result\").html(\"<p class='loading'>&nbsp;&nbsp;&nbsp;&nbsp;</p>\");\r\n     $.post(url,{location:loc,category:category,keywords:kw} , function(data, textStatus, jqXHR){\r\n        //console.log(\"Data\",data,textStatus);         \r\n       buildProductsUi(data.products);\r\n       allProducts[currentPage] = data.products;\r\n     });\r\n }*/\r\n \r\n function buildProductsUi(productsList){\r\n      $(\".product-result\").html(\"\");    \r\n        var content=\"<table width='100%'>\";\r\n        for(var i=0;i<productsList.length;i++){             \r\n             content+=\"<tr class='product-item'  onmouseoutNO='productDetailsClear(\"+i+\")' ondblclick='productEdit(\"+i+\")' id='\"+productsList[i]._id+\"'>\";\r\n             content+=\"<td width='90%' onclick='productDetails(\"+i+\")'><b>\"+productsList[i].title+\"</td>\";             \r\n             content+=\"</td><td> <i class='action-edit' title='Edit the product'    onclick='productEdit(\"+i+\")'/> \";             \r\n             content+=\" <i class='action-remove' title='Delete the product' onclick='productRemove(\"+i+\")'/> \";\r\n             content+=\"</td></tr>\";\r\n        }\r\n        content+=\"</table>\";\r\n        $(\".product-result\").append(content);        \r\n        $( \".action-remove\" ).button({text: false,icons: {primary: \"ui-icon-closethick\"}});\r\n        $( \".action-edit\" ).button({text: false,icons: {primary: \"ui-icon-pencil\"}});\r\n        $( \".action-like\" ).button({text: false,icons: {primary: \"ui-icon-check\"}});\r\n        $( \".action-mark\" ).button({text: false,icons: {primary: \"ui-icon-comment\"}});\r\n        $( \".action-erronous\" ).button({text: false,icons: {primary: \"ui-icon-cancel\"}});\r\n        $( \".product-result tr:odd\" ).addClass(\"odd-tr\");\r\n }\r\n\r\n function productRemove(i){\r\n     if(!isAuthenticated){\r\n         $.colorbox({html:\"<div id='connectBefore' style='color:white'>Please <b>Login</b> (<small>at the top right</small>) before.</div>\"});\r\n         console.log(\"Not Auth\");\r\n         return;\r\n     }\r\n     if (confirm(\"Sure you wanna delete it?\")){\r\n         var url = '/deleteproduct';\r\n         $.post( url,{_id:allProducts[currentPage][i]._id});\r\n         $(\"#\"+allProducts[currentPage][i].id).remove();\r\n     }\r\n }\r\n \r\n \r\n function productEdit(i){     \r\n     if(!isAuthenticated){\r\n         $.colorbox({html:\"<div id='connectBefore' style='color:white'>Please <b>Login</b> (<small>at the top right</small>) before.</div>\"});\r\n         return;\r\n     }\r\n    //Fill all values    \r\n    $.colorbox(colorBoxOptions);          \r\n    newProductvalidator.resetForm();\r\n    for(var field in allProducts[currentPage][i]){\r\n        $(\"#newproductform #\"+field).val(allProducts[currentPage][i][field]);           \r\n    }\r\n }\r\n \r\n function productDetails(i){         \r\n    $(\".product-item\").removeClass('ui-state-hover'); \r\n    $(\".product-details\").remove();\r\n    $(\"#\"+allProducts[currentPage][i]._id).addClass('ui-state-hover');           \r\n    $('#towner-main').append(productDetailsTemplate);  \r\n    //Fill values\r\n    for(var field in allProducts[currentPage][i]){\r\n        $(\"#product-details-\"+field).html(allProducts[currentPage][i][field] || 'n/a');           \r\n    }    \r\n    $( \"#mark-action\" ).button({text: false,icons: {primary: \"ui-icon-pencil\"}});\r\n    $( \"#like-action\" ).button({text: false,icons: {primary: \"ui-icon-circle-arrow-n\"}});\r\n    $( \"#unlike-action\" ).button({text: false,icons: {primary: \"ui-icon-circle-arrow-s\"}});\r\n    $( \"#signal-action\" ).button({text: false,icons: {primary: \"ui-icon-cancel\"}});\r\n    $( \"#close-action\" ).button({text: false,icons: {primary: \"ui-icon-close\"}});\r\n    \r\n } \r\n \r\n \r\n function productDetailsClear(i){\r\n     var i=i||1;\r\n     $(\"#\"+allProducts[currentPage][i]._id).removeClass('ui-state-hover');\r\n    $(\".product-details\").remove();\r\n }\r\n \r\n function productScore(type,val,i){     \r\n     //type: -1=dislike, -2=erronous, 1=like,2=mark \r\n     if(!isAuthenticated){\r\n         $.colorbox({html:\"<div id='connectBefore' style='color:white'>Please <b>Login</b> (<small>at the top right</small>) before.</div>\"});\r\n         return;\r\n     }else{         \r\n         switch(type){\r\n            case enums.scores.mark:\r\n                 break;\r\n            case enums.scores.like:\r\n                 break;\r\n            case enums.scores.unlike:\r\n                 break;\r\n            case enums.scores.erronous:\r\n                 break;     \r\n         }\r\n          $.post('/score',{scoretype:type,val:val,id:allProducts[currentPage][i]._id} , function(data, textStatus, jqXHR){\r\n            console.log(\"Data\",data,textStatus);                 \r\n         });\r\n    }\r\n }\r\n \r\n function newProductInit() {        \r\n        newProductvalidator = $(\"#newproductform\").validate();         \r\n        //$( \".dlt-datepicker\" ).datepicker();\r\n        $(\"#new-product-submit\").button().click(function(){\r\n            \r\n            if(newProductvalidator.form()){                \r\n            \t$(\"#newproductform\").ajaxSubmit({success:function(data){\r\n                    //console.log(data);\r\n                }});                \r\n                newProductvalidator.resetForm();\r\n                $.colorbox.close();\r\n            }\r\n        });\r\n        $(\"#new-product-cancel\").button().click(function(){\r\n            newProductvalidator.resetForm();\r\n        });\r\n }\r\n \r\n function createProductAt(loc){\r\n    if(!isAuthenticated){\r\n         $.colorbox({html:\"<div id='connectBefore' style='color:white'>Please <b>Login</b> (<small>at the top right</small>) before.</div>\"});\r\n         return;\r\n     } \r\n    var loc = loc || marker.getPosition();\r\n    $(\"#newproductform #locationLng\").val(loc.lng());\r\n    $(\"#newproductform #locationLat\").val(loc.lat());          \r\n    geocoder.geocode({'latLng': loc}, function(results, status) {\r\n      if (status == google.maps.GeocoderStatus.OK) {\r\n        if (results[1]) {\r\n            $(\"#newproductform #locationStr\").val(results[1].formatted_address);\r\n        }\r\n      } else {\r\n        console.log(\"Geocoder failed due to: \" + status);\r\n      }\r\n    });     \r\n    $.colorbox(colorBoxOptions);      \r\n }\r\n \r\n function loadResults(pageNum){\r\n     currentPage = pageNum || initPage;  \r\n     console.log(\"currentPage\",currentPage);\r\n     if(currentPage==-1){\r\n         //Reset search\r\n         currentPage = initPage;\r\n         allProducts[currentPage]=null;\r\n     }\r\n     if(!(allProducts[currentPage])){\r\n         \r\n         var loc =  [marker.getPosition().lng(),marker.getPosition().lat()]\r\n         ,category = $('#category-filter').val(), keywords = $('#content-filter').val();\r\n         var url = '/storelocation/'+currentPage,reg = new RegExp(\"[ ,;\\+]+\", \"g\");\r\n         var kw  = (keywords?keywords.split(reg):[]);     \r\n         $(\".product-result\").html(\"<p class='loading'>&nbsp;&nbsp;&nbsp;&nbsp;</p>\");\r\n         $.post(url,{location:loc,category:category,keywords:kw} , function(data, textStatus, jqXHR){\r\n            //console.log(\"Data\",data,textStatus);         \r\n           buildProductsUi(data.products);\r\n           allProducts[currentPage] = data.products;\r\n         });         \r\n     }else{\r\n         buildProductsUi(allProducts[currentPage]);\r\n     }\r\n }\r\n \r\n /******* Socket.io ***************/\r\n    //var socket = io.connect(serverUrl);\r\n    /* socket.on('news', function (data) {\r\n    console.log(data);\r\n    socket.emit('my other event', { my: 'data' });\r\n    });*/\r\n    \r\n    var channel1 = io.connect(serverUrl+'/channel1?token=aXoqIwP');\r\n    channel1.on('news', function (data) {\r\n        //console.log(data);\r\n        //channel1.emit('my other event', { my: 'data' });\r\n    });\r\n    \r\n    var channel2 = io.connect(serverUrl+'/channel2?token=aXoqIwP');\r\n    channel2.on('news', function (data) {\r\n        //console.log(data);\r\n        //channel2.emit('my other event', { my: 'data' });\r\n    });"]],"start1":0,"start2":0,"length1":0,"length2":13255}]],"length":13255}
